<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote in Election</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body>
    <main class="p-6 space-y-6 bg-gray-100 min-h-screen">
        <!-- Election Voting Header -->
        <div class="text-2xl font-bold text-dark-green">Vote in Election</div>

        <!-- Voting Section -->
        <section class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-4">Cast Your Vote</h3>
            <form method="POST" action="/api/vote/" id="vote-form" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label for="poll" class="block text-sm font-medium">Select Poll</label>
                    <select id="poll" name="poll_id" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" required>
                        <option value="" disabled selected>Select a poll</option>
                        {% for poll in polls %}
                            <option value="{{ poll.id }}">{{ poll.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="option" class="block text-sm font-medium">Select Option</label>
                    <select id="option" name="option_id" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" required>
                        <option value="" disabled selected>Select an option</option>
                        <!-- Options will be populated based on the selected poll -->
                    </select>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="w-full md:w-auto bg-dark-green text-white px-6 py-2 rounded-lg">Vote</button>
                <div id="success-message" class="hidden text-green-500 text-sm font-semibold mt-4"></div>
            </form>
        </section>

        <!-- Submit Election Section -->
        <section class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-4">Submit Election</h3>
            <button id="submit-election" class="w-full md:w-auto bg-blue-600 text-white px-6 py-2 rounded-lg">Submit Election</button>
        </section>

        <!-- Success Prompt Modal -->
        <div id="success-prompt" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                <h3 class="text-lg font-semibold mb-4">Success!</h3>
                <p class="mb-4">You have successfully voted!</p>
                <button id="continue-button" class="bg-dark-green text-white px-4 py-2 rounded-lg">Continue</button>
            </div>
        </div>
    </main>

    <script>
        // Fetch options based on selected poll
        document.getElementById('poll').addEventListener('change', function() {
            const pollId = this.value;
            fetch(`/api/polls/${pollId}/options/`)
                .then(response => response.json())
                .then(data => {
                    const optionSelect = document.getElementById('option');
                    optionSelect.innerHTML = '<option value="" disabled selected>Select an option</option>';
                    data.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.id;
                        opt.textContent = option.text;
                        optionSelect.appendChild(opt);
                    });
                })
                .catch(error => {
                    console.error('Error fetching options:', error);
                });
        });

        // Vote submission handling
        document.getElementById('vote-form').addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent default form submission
            const formData = new FormData(this);

            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}', // CSRF token for security
                    },
                    body: formData
                });

                if (response.ok) {
                    document.getElementById('success-message').textContent = "Vote submitted successfully!";
                    document.getElementById('success-message').classList.remove('hidden'); // Show success message
                    
                    // Show success prompt modal
                    document.getElementById('success-prompt').classList.remove('hidden');
                } else {
                    const errorData = await response.json();
                    console.error('Error:', errorData);
                }
            } catch (error) {
                console.error('Network error:', error);
            }
        });

        // Redirect to landing page on continue button click
        document.getElementById('continue-button').addEventListener('click', function() {
            window.location.href = '/landing-page/'; // Replace with your landing page URL
        });
    </script>
</body>
</html>
